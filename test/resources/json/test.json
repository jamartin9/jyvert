{"version":2,"jobs":{"build":{"docker":[{"image":"ubuntu:14.04"},{"image":"mongo:2.6.8","command":["mongod","--smallfiles"]},{"image":"postgres:9.4.1","environment":{"POSTGRES_USER":"root"}},{"image":"redis@sha256:54057dd7e125ca41afe526a877e8bd35ec2cdd33b9217e022ed37bdcf7d09673"},{"image":"rabbitmq:3.5.4"}],"environment":{"TEST_REPORTS":"\/tmp\/test-reports"},"working_directory":"~\/my-project","branches":{"ignore":["develop","\/feature-.*\/"]},"steps":["checkout",{"run":{"command":"echo 127.0.0.1 devhost | sudo tee -a \/etc\/hosts"}},{"run":"sudo -u root createuser -h localhost --superuser ubuntu &&\nsudo createdb -h localhost test_db\n"},{"restore_cache":{"keys":["v1-my-project-{{ checksum \"project.clj\" }}","v1-my-project-"]}},{"run":{"environment":{"SSH_TARGET":"localhost","TEST_ENV":"linux"},"command":"set -xu\nmkdir -p ${TEST_REPORTS}\nrun-tests.sh\ncp out\/tests\/*.xml ${TEST_REPORTS}\n"}},{"run":"set -xu\nmkdir -p \/tmp\/artifacts\ncreate_jars.sh ${CIRCLE_BUILD_NUM}\ncp *.jar \/tmp\/artifacts\n"},{"save_cache":{"key":"v1-my-project-{{ checksum \"project.clj\" }}","paths":["~\/.m2"]}},{"store_artifacts":{"path":"\/tmp\/artifacts","destination":"build"}},{"store_test_results":{"path":"\/tmp\/test-reports"}}]},"deploy-stage":{"docker":[{"image":"ubuntu:14.04"}],"working_directory":"\/tmp\/my-project","steps":[{"run":{"name":"Deploy if tests pass and branch is Staging","command":"ansible-playbook site.yml -i staging"}}]},"deploy-prod":{"docker":[{"image":"ubuntu:14.04"}],"working_directory":"\/tmp\/my-project","steps":[{"run":{"name":"Deploy if tests pass and branch is Master","command":"ansible-playbook site.yml -i production"}}]}},"workflows":{"version":2,"build-deploy":{"jobs":["build",{"deploy-stage":{"requires":["build"],"filters":{"branches":{"only":"staging"}}}},{"deploy-prod":{"requires":["build"],"filters":{"branches":{"only":"master"}}}}]}}}